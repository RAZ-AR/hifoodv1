# üîß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Row Level Security –≤ Supabase

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
new row violates row-level security policy for table "users"
```

## –†–µ—à–µ–Ω–∏–µ
–ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase.

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [https://supabase.com](https://supabase.com)
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç
3. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç **hifoodv1** (–∏–ª–∏ –≤–∞—à–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞)

### –®–∞–≥ 2: –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor
1. –í –ª–µ–≤–æ–º –º–µ–Ω—é –Ω–∞–π–¥–∏—Ç–µ **"SQL Editor"**
2. –ù–∞–∂–º–∏—Ç–µ **"New query"** (–∏–ª–∏ –∫–Ω–æ–ø–∫—É "+ New Query")

### –®–∞–≥ 3: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `backend/fix-rls-policies.sql` –≤ —ç—Ç–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–≤–µ—Å—å —Ç–µ–∫—Å—Ç** –∏–∑ —Ñ–∞–π–ª–∞
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –≤ Supabase
4. –ù–∞–∂–º–∏—Ç–µ **"Run"** (–∏–ª–∏ Ctrl/Cmd + Enter)

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–æ –≤—Å–µ–º–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏:

```
schemaname | tablename           | policyname                                    | permissive | roles                    | cmd
-----------|---------------------|-----------------------------------------------|------------|--------------------------|--------
public     | bonus_transactions  | Allow backend to delete bonus_transactions    | PERMISSIVE | anon,authenticated       | DELETE
public     | bonus_transactions  | Allow backend to insert bonus_transactions    | PERMISSIVE | anon,authenticated       | INSERT
public     | bonus_transactions  | Allow backend to select bonus_transactions    | PERMISSIVE | anon,authenticated       | SELECT
public     | bonus_transactions  | Allow backend to update bonus_transactions    | PERMISSIVE | anon,authenticated       | UPDATE
public     | orders              | Allow backend to delete orders                | PERMISSIVE | anon,authenticated       | DELETE
public     | orders              | Allow backend to insert orders                | PERMISSIVE | anon,authenticated       | INSERT
public     | orders              | Allow backend to select orders                | PERMISSIVE | anon,authenticated       | SELECT
public     | orders              | Allow backend to update orders                | PERMISSIVE | anon,authenticated       | UPDATE
public     | users               | Allow backend to delete users                 | PERMISSIVE | anon,authenticated       | DELETE
public     | users               | Allow backend to insert users                 | PERMISSIVE | anon,authenticated       | INSERT
public     | users               | Allow backend to select users                 | PERMISSIVE | anon,authenticated       | SELECT
public     | users               | Allow backend to update users                 | PERMISSIVE | anon,authenticated       | UPDATE
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞:

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞ **@Hi_food_order_bot**
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/start` —Å **–Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞** (–∏–ª–∏ —Ç–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É)
3. –í—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
   ```
   üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, [–≤–∞—à–µ –∏–º—è]!

   üéâ –í–∞–º –≤—ã–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏!
   –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 1001

   üì± –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã:
   ‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é
   ‚Ä¢ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
   ‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏
   ‚Ä¢ –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –±–æ–Ω—É—Å—ã
   ```

4. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ ‚Äî **–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

---

## üö® –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã (—Å–º. "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Render: [https://dashboard.render.com](https://dashboard.render.com)
4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏

---

## üìö –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç?

1. **–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏** ‚Äî —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–Ω–µ–µ, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. **–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `users`**:
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç SELECT (—á—Ç–µ–Ω–∏–µ)
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç INSERT (—Å–æ–∑–¥–∞–Ω–∏–µ)
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç UPDATE (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç DELETE (—É–¥–∞–ª–µ–Ω–∏–µ)
3. **–°–æ–∑–¥–∞—ë—Ç —Ç–∞–∫–∏–µ –∂–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü `orders` –∏ `bonus_transactions`**
4. **–†–∞–∑—Ä–µ—à–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–æ–ª–µ–π `anon` –∏ `authenticated`** ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–æ–ª–∏ Supabase –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–æ–ø—Ä–æ—Å:** –ù–µ –æ–ø–∞—Å–Ω–æ –ª–∏ —Ä–∞–∑—Ä–µ—à–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è `anon`?

**–û—Ç–≤–µ—Ç:** –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `SUPABASE_SERVICE_ROLE_KEY` –≤ backend'–µ
2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
3. API endpoints –∑–∞—â–∏—â–µ–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ Express
4. –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ")

**–î–ª—è production** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
CREATE POLICY "Users can update own data"
ON users FOR UPDATE
TO authenticated
USING (telegram_id = auth.jwt()->>'telegram_id')
WITH CHECK (telegram_id = auth.jwt()->>'telegram_id');
```

–ù–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ! üëç
